// ========================================
// ğŸ”’ Firestore Security Rules
// Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
// ========================================
//
// Ø§Ù†Ø³Ø® Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø¥Ù„Ù‰ Firebase Console > Firestore > Rules
// Copy these rules to Firebase Console > Firestore > Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // Helper Functions
    // ========================================
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function hasRequiredFields(data, fields) {
      return data.keys().hasAll(fields);
    }
    
    // ========================================
    // Users Collection - Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    // ========================================
    match /users/{userId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ
      allow read: if isSignedIn() && isOwner(userId);
      
      // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡ Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      allow create: if isSignedIn() && isOwner(userId);
      
      // Ø§Ù„ØªØ­Ø¯ÙŠØ«: ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ
      allow update: if isSignedIn() && isOwner(userId);
      
      // Ø§Ù„Ø­Ø°Ù: Ù…Ù…Ù†ÙˆØ¹ (Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
      allow delete: if false;
      
      // ========================================
      // Vehicles Subcollection - Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      // ========================================
      match /vehicles/{vehicleId} {
        // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ
        allow read: if isSignedIn() && isOwner(userId);
        
        // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        allow create: if isSignedIn() && isOwner(userId)
          && request.resource.data.keys().hasAny(['make', 'model', 'customerName']);
        
        // Ø§Ù„ØªØ­Ø¯ÙŠØ«: ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ
        allow update: if isSignedIn() && isOwner(userId);
        
        // Ø§Ù„Ø­Ø°Ù: ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ
        allow delete: if isSignedIn() && isOwner(userId);
      }
      
      // ========================================
      // Backups Subcollection - Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
      // ========================================
      match /backups/{backupId} {
        allow read: if isSignedIn() && isOwner(userId);
        allow create: if isSignedIn() && isOwner(userId);
        allow delete: if isSignedIn() && isOwner(userId);
      }
    }
    
    // ========================================
    // Default: Deny All - Ø±ÙØ¶ ÙƒÙ„ Ø´ÙŠØ¡ Ø¢Ø®Ø±
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
